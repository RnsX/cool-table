import type { NextPage } from 'next'
import Head from 'next/head'
import Image from 'next/image'
import { MouseEventHandler, useState } from 'react'
import ComContainer from '../components/Comments/ComContainer'
import styles from '../styles/Home.module.css'


interface IRow {
  rowNum: number, id: number, name: string, description: string, status: string, comments: string[]
}

interface ITable {
  items: IRow[]
}

const Home: NextPage = () => {

  function getRandomInt(min:number, max:number) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  const [table, setTable] = useState<ITable>({
    items: [
      {rowNum: 1, id: 1, name: 'calculate monthly turnover', description: 'needed for business', status: 'waiting requirements', comments: ["added new item", "modified that item"]},
      {rowNum: 2, id: 2, name: 'calculate credit turnover', description: 'needed for business', status: 'waiting requirements', comments: ["this should be canceled"]},
      {rowNum: 3, id: 3, name: 'calculate debit turnover', description: 'needed for business', status: 'waiting requirements', comments: ["postponed", "returned to high priority", "soon completed, waiting on data"]},
      {rowNum: 4, id: 4, name: 'calculate deposit turnover', description: 'needed for business', status: 'waiting requirements', comments: []},
    ]
  });

  const [showMenu, setShowMenu] = useState({
    visible: false,
    rowId: 0,
    locationX: 0,
    locationY: 0
  });
  
  const addRow = (addBelow: number) => {
    console.log('insert under', addBelow);
    let current = table.items;
    let newRowNum = addBelow+1;
    let newId = getRandomInt(0,10000);

    current.forEach(row => {
      row.rowNum > addBelow ? row.rowNum++ : row.rowNum = row.rowNum;
    });

    current.push({ rowNum: newRowNum, id: newId, name:'', description:'', status:'new', comments: [] });
    
    current.sort(function(a, b) { 
      return a.rowNum - b.rowNum;
    });

    console.log('sorted array',current);
    setTable({ items: current});
    resetMenu();
  }

  const resetMenu =() => {
    setShowMenu({...showMenu, visible: false});
  }

  const showRightClick = (xPos: number, yPos: number, rowId: string, e: React.MouseEvent<HTMLTableRowElement>) => {
    e.preventDefault();
    console.log('pressed right click on', rowId);
    setShowMenu({ visible: true, rowId:  parseInt(rowId), locationX: xPos, locationY: yPos});
  }

  const [comModal, setComModal] = useState({
    visible: false,
    contents: "",
    createdBy: "",
    date: "",
    forRowId: 0
  })

  const showCommentModal = (id: number) => {
    setComModal({...comModal, visible: true, forRowId: id});
    resetMenu();
  }

  const closeModal = () => {
    setComModal({ visible: false, contents: '', createdBy: '', date: '', forRowId: 0});
  }

  const saveCommentModal = () => {

  }

  return (
    <div className={styles.container}>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
        <link rel="stylesheet" href= "https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"/>

      </Head>
      <div>
        <div className='comment-modal'>
          <div className='comment-window'>
            <button className='btn btn-danger comment-btn-close' onClick={closeModal}>x</button>
            <label>Comment</label>
            <input className='form-input'/>
            
            <label>Created by</label>
            <input className='form-input'/>

            <label>Date created</label>
            <input className='form-input'/>

            <button className='btn btn-outline-success' onClick={saveCommentModal}>Save</button>
          </div>
        </div>
        <div className='rightClickMenu'>
          <button onClick={() => {setShowMenu({ visible: false, rowId: 0, locationX: 0, locationY: 0 })}} className='btn btn-danger'>Cancel</button>
          <button id={showMenu.rowId.toString()} onClick={(e: React.MouseEvent<HTMLButtonElement>) => addRow(parseInt(e.currentTarget.id))} className='btn btn-outline-primary'>Add row</button>
          <button id={showMenu.rowId.toString()} onClick={(e: React.MouseEvent<HTMLButtonElement>) => showCommentModal(parseInt(e.currentTarget.id))} className='btn btn-outline-primary'>New comment</button>
        
        </div>
        <table className='table table-hover tableAdditional' >
          <tr>
            <th>Id</th>            
            <th>Name</th>            
            <th>Description</th>            
            <th>Status</th>            
            <th>Comments</th>
          </tr>
          {
            table.items.map((x)=> {
              return (
                <tr key={x.id} id={(x.rowNum).toString()}
                  onContextMenu={(e: React.MouseEvent<HTMLTableRowElement>) => showRightClick(e.pageX, e.pageY, e.currentTarget.id, e)}
                >
                  <td>{x.id}</td>
                  <td>{x.name}</td>
                  <td>{x.description}</td>
                  <td>{x.status}</td>
                  <td>
                    <ul>
                      <ComContainer comments={x.comments} />
                    </ul> 
                  </td>
                </tr>
              )
            })
          }
        </table>
      </div>
      <style jsx>
        {
          `
            .comment-modal {
              position: absolute;
              width: 100%;
              height: 100vh;

              display: ${comModal.visible == true ? 'flex' : 'none'};
              justify-content: center;
              align-items: center;
              overflow: hidden;
            }
            .comment-window {
              width: 400px;
              height: fit-content;
              border: 1px solid lightgray;
              border-radius: 0.5em;
              -webkit-box-shadow: 0px 0px 22px 4px rgba(0,0,0,0.3); 
              box-shadow: 0px 0px 22px 4px rgba(0,0,0,0.3);
              background-color: white;
              display: flex;
              flex-direction: column;
              justify-content: flex-start;
              align-items: flex-start;
              padding: 1em;
            }
            .comment-window > button,input {
              width: 100%;
              margin-bottom: 0.8em;
            }

            .comment-btn-close {
              position: relative;
              max-width: fit-content;
              margin-left: auto;
              padding: 0em 0.4em 0em 0.4em;
            }

            .rightClickMenu {
              width: 120px;
              height: 100px;
              border: 1px solid lightgray;
              padding: 0.33em;
              display: ${showMenu.visible == true ? 'flex' : 'none'};
              flex-direction: column;
              justify-content: flex-start;
              position: absolute;
              background-color: white;
              transform: translate(${showMenu.locationX}px, ${showMenu.locationY}px);
              border-radius: 0.5em;
              -webkit-box-shadow: 0px 0px 22px 4px rgba(0,0,0,0.3); 
              box-shadow: 0px 0px 22px 4px rgba(0,0,0,0.3);
              z-index: 99;
            }
            
            .rightClickMenu > button {
              padding: 0.2em;
              font-size: small;
              margin-bottom: 0.25em;
            }
            
            .tableAdditional {
              user-select: none;
            }

            .tableAdditional > tr:hover {
              background-color: #f3f3f3;
              cursor: pointer;
            }

            .closeButton {
              color: red;
            }
          `
        }
      </style>
    </div>
  )
}

export default Home
